<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>P2P Bitcoin Bet</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    .hidden { display: none; }
    input, button { margin: 5px 0; padding: 8px; width: 100%; }
    .bet-box { border: 1px solid #ccc; padding: 15px; margin-top: 20px; border-radius: 8px; }
    .highlight { background: #f0f8ff; padding: 10px; border-radius: 5px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>P2P Bitcoin Bet</h1>

  <!-- Create Bet Form -->
  <div id="create-bet" class="bet-box">
    <h2>Create a Bet</h2>
    <input type="text" id="nameA" placeholder="Your Name">
    <input type="text" id="terms" placeholder="Bet terms (e.g. Chiefs win Super Bowl)">
    <input type="number" id="sats" placeholder="Amount (sats)">
    <input type="text" id="addrA" placeholder="Your Lightning Address">
    <button onclick="createBet()">Create Bet</button>
  </div>

  <!-- Bet Info Display + Share Link -->
  <div id="bet-info" class="bet-box hidden">
    <h2>Bet Info</h2>
    <p><strong>Creator:</strong> <span id="d-nameA"></span></p>
    <p><strong>Terms:</strong> <span id="d-terms"></span></p>
    <p><strong>Amount:</strong> <span id="d-sats"></span> sats</p>
    <p><strong>Lightning Address:</strong> <span id="d-addrA"></span></p>

    <h3>Share this link with your opponent</h3>
    <input type="text" id="share-link" readonly style="width: 80%;">
    <button onclick="copyLink()">Copy Link</button>
  </div>

  <!-- Accept Bet Form for Person B -->
  <div id="accept-bet" class="bet-box hidden">
    <h2>Accept Bet</h2>
    <p><strong>Creator:</strong> <span id="b-nameA"></span></p>
    <p><strong>Terms:</strong> <span id="b-terms"></span></p>
    <p><strong>Amount:</strong> <span id="b-sats"></span> sats</p>
    <p><strong>Creator Lightning Address:</strong> <span id="b-addrA"></span></p>

    <input type="text" id="nameB" placeholder="Your Name">
    <input type="text" id="termsB" placeholder="Your Bet Terms (optional)">
    <input type="text" id="addrB" placeholder="Your Lightning Address">
    <button onclick="acceptBet()">Accept Bet</button>
  </div>

  <!-- Outcome Section -->
  <div id="outcome-section" class="bet-box hidden">
    <h3>Decide Outcome</h3>
    <button id="btn-won">I Won</button>
    <button id="btn-lost">I Lost</button>
    <div id="winner-message" class="hidden highlight"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>

  <script>
    // ðŸ”¹ Replace this config with your Firebase project config
    const firebaseConfig = {
      apiKey: "AIzaSyAsIg1JTz4PyNfCHWyZCzX-_94Uj_oEyZw",
      authDomain: "p2pbet-59eff.firebaseapp.com",
      databaseURL: "https://p2pbet-59eff-default-rtdb.firebaseio.com",
      projectId: "p2pbet-59eff",
      storageBucket: "p2pbet-59eff.firebasestorage.app",
      messagingSenderId: "613932768243",
      appId: "1:613932768243:web:a77df7469e9fee464d5086"
      measurementId: "G-0E2L01X5LL"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ðŸ”¹ Generate or read bet ID from URL
    let betId = new URLSearchParams(window.location.search).get("bet");
    if (!betId) {
      betId = "bet-" + Date.now() + "-" + Math.floor(Math.random() * 10000);
      window.history.replaceState({}, "", "?bet=" + betId);
    }
    const dbRef = db.ref("bets/" + betId);

    let currentUser = "";

    function createBet() {
      const bet = {
        nameA: document.getElementById("nameA").value,
        terms: document.getElementById("terms").value,
        sats: document.getElementById("sats").value,
        addrA: document.getElementById("addrA").value,
        nameB: "",
        addrB: "",
        accepted: false,
        winner: "",
        winnerAddr: "",
        createdAt: Date.now()
      };
      currentUser = bet.nameA;
      dbRef.set(bet);

      document.getElementById("create-bet").classList.add("hidden");
      document.getElementById("bet-info").classList.remove("hidden");

      document.getElementById("d-nameA").textContent = bet.nameA;
      document.getElementById("d-terms").textContent = bet.terms;
      document.getElementById("d-sats").textContent = bet.sats;
      document.getElementById("d-addrA").textContent = bet.addrA;

      const link = window.location.origin + window.location.pathname + "?bet=" + betId;
      document.getElementById("share-link").value = link;
    }

    function acceptBet() {
      dbRef.update({
        nameB: document.getElementById("nameB").value,
        termsB: document.getElementById("termsB").value,
        addrB: document.getElementById("addrB").value,
        accepted: true
      });
      currentUser = document.getElementById("nameB").value;
    }

    function iWon() {
      dbRef.once("value").then(snap => {
        const bet = snap.val();
        const winnerAddr = (currentUser === bet.nameA) ? bet.addrA : bet.addrB;
        dbRef.update({
          winner: currentUser,
          winnerAddr: winnerAddr,
          finishedAt: Date.now()
        });
      });
    }

    function iLost() {
      dbRef.once("value").then(snap => {
        const bet = snap.val();
        const winner = (currentUser === bet.nameA) ? bet.nameB : bet.nameA;
        const winnerAddr = (currentUser === bet.nameA) ? bet.addrB : bet.addrA;
        dbRef.update({
          winner: winner,
          winnerAddr: winnerAddr,
          finishedAt: Date.now()
        });
      });
    }

    function copyLink() {
      const linkInput = document.getElementById("share-link");
      linkInput.select();
      linkInput.setSelectionRange(0, 99999);
      navigator.clipboard.writeText(linkInput.value).then(() => {
        alert("Link copied!");
      });
    }

    function showWinner(bet) {
      const msg = document.getElementById("winner-message");
      msg.classList.remove("hidden");
      msg.textContent =
        `ðŸ† Winner: ${bet.winner}! Receive ${bet.sats} sats at: ${bet.winnerAddr}`;
    }

    dbRef.on("value", snap => {
      const bet = snap.val();
      if (!bet) return;

      // Clear finished bets after 24 hours
      if (bet.finishedAt && (Date.now() - bet.finishedAt > 24 * 60 * 60 * 1000)) {
        dbRef.remove();
        location.reload();
        return;
      }

      // Show creator info to B
      if (!bet.accepted && bet.nameA) {
        document.getElementById("create-bet").classList.add("hidden");
        document.getElementById("accept-bet").classList.remove("hidden");
        document.getElementById("b-nameA").textContent = bet.nameA;
        document.getElementById("b-addrA").textContent = bet.addrA;
        document.getElementById("b-terms").textContent = bet.terms;
        document.getElementById("b-sats").textContent = bet.sats;
      }

      if (bet.accepted && !bet.winner) {
        document.getElementById("accept-bet").classList.add("hidden");
        document.getElementById("outcome-section").classList.remove("hidden");
      }

      if (bet.winner) showWinner(bet);
    });

    document.getElementById("btn-won").addEventListener("click", iWon);
    document.getElementById("btn-lost").addEventListener("click", iLost);
  </script>
</body>
</html>
